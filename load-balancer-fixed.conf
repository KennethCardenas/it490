# Improved Load Balancer Configuration for IT490 App
# This configuration handles session persistence and form submissions correctly

<VirtualHost *:80>
    ServerName 178.156.166.191
    ServerAlias your-domain.com
    
    # Enable mod_status for monitoring load balancer
    <Location "/balancer-manager">
        SetHandler balancer-manager
        # Add IP restrictions here for security
        # Require ip 192.168.1
    </Location>
    
    # Define the balancer cluster
    ProxyPreserveHost On
    
    # Exclude management endpoints from proxying
    ProxyPass /balancer-manager !
    ProxyPass /server-status !
    
    # Main application load balancing with session stickiness
    ProxyPass / balancer://mycluster/ stickysession=JSESSIONID
    ProxyPassReverse / balancer://mycluster/
    
    # Define the cluster with your two app servers
    <Proxy balancer://mycluster>
        # First server (port 8080 backend)
        BalancerMember http://localhost:8080 route=server1
        # Second server (178.156.159.246)
        BalancerMember http://178.156.159.246:80 route=server2
        
        # Load balancing method - round robin by requests
        ProxySet lbmethod=byrequests
        
        # Health check settings (requires mod_proxy_hcheck)
        # ProxySet hcmethod=GET
        # ProxySet hcuri=/
    </Proxy>
    
    # Enhanced session stickiness for maintaining user sessions
    # This ensures that users stick to the same backend server for their entire session
    Header add Set-Cookie "JSESSIONID=%{BALANCER_WORKER_ROUTE}e; Path=/"
    
    # Additional headers for better session handling
    Header always set X-Backend-Server "%{BALANCER_WORKER_ROUTE}e"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/load_balancer_error.log
    CustomLog ${APACHE_LOG_DIR}/load_balancer_access.log combined
    
    # Optional: Enable server status monitoring
    <Location "/server-status">
        SetHandler server-status
        Require all granted
        # Add IP restrictions here for security
        # Require ip 192.168.1
    </Location>
</VirtualHost>

# Additional configuration for SSL (port 443) if needed
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName 178.156.166.191
    ServerAlias your-domain.com
    
    # SSL configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    
    # Same load balancing configuration for HTTPS
    ProxyPreserveHost On
    ProxyPass /balancer-manager !
    ProxyPass /server-status !
    ProxyPass / balancer://mycluster-ssl/ stickysession=JSESSIONID
    ProxyPassReverse / balancer://mycluster-ssl/
    
    <Proxy balancer://mycluster-ssl>
        BalancerMember https://localhost:8443 route=server1
        BalancerMember https://178.156.159.246:443 route=server2
        ProxySet lbmethod=byrequests
    </Proxy>
    
    Header add Set-Cookie "JSESSIONID=%{BALANCER_WORKER_ROUTE}e; Path=/"
    Header always set X-Backend-Server "%{BALANCER_WORKER_ROUTE}e"
    
    ErrorLog ${APACHE_LOG_DIR}/load_balancer_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/load_balancer_ssl_access.log combined
</VirtualHost>
</IfModule> 