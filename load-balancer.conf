# Load Balancer Configuration for IT490 App
# This configuration implements basic Apache load balancing between two app servers

<VirtualHost *:80>
    ServerName your-domain.com
    
    # Enable mod_status for monitoring load balancer
    <Location "/balancer-manager">
        SetHandler balancer-manager
        # Add IP restrictions here for security
        # Require ip 192.168.1
    </Location>
    
    # Define the balancer cluster
    ProxyPreserveHost On
    
    # Main application load balancing
    ProxyPass /balancer-manager !
    ProxyPass /server-status !
    ProxyPass / balancer://mycluster/
    ProxyPassReverse / balancer://mycluster/
    
    # Define the cluster with your two app servers
    <Proxy balancer://mycluster>
        # First server (current local server)
        BalancerMember http://localhost:80 status=+H
        # Second server (178.156.159.246)
        BalancerMember http://178.156.159.246:80 status=+H
        
        # Load balancing method - round robin by requests
        ProxySet lbmethod=byrequests
        
        # Health check settings (requires mod_proxy_hcheck)
        # ProxySet hcmethod=GET
        # ProxySet hcuri=/
    </Proxy>
    
    # Session stickiness for maintaining user sessions
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/load_balancer_error.log
    CustomLog ${APACHE_LOG_DIR}/load_balancer_access.log combined
    
    # Optional: Enable server status monitoring
    <Location "/server-status">
        SetHandler server-status
        Require all granted
        # Add IP restrictions here for security
        # Require ip 192.168.1
    </Location>
</VirtualHost>

# Additional configuration for SSL (port 443) if needed
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName your-domain.com
    
    # SSL configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    
    # Same load balancing configuration for HTTPS
    ProxyPreserveHost On
    ProxyPass /balancer-manager !
    ProxyPass / balancer://mycluster-ssl/
    ProxyPassReverse / balancer://mycluster-ssl/
    
    <Proxy balancer://mycluster-ssl>
        BalancerMember https://localhost:443 status=+H
        BalancerMember https://178.156.159.246:443 status=+H
        ProxySet lbmethod=byrequests
    </Proxy>
    
    ErrorLog ${APACHE_LOG_DIR}/load_balancer_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/load_balancer_ssl_access.log combined
</VirtualHost>
</IfModule>